{% extends "base.html" %}

{% block head %}
  {{ super() }}
{% endblock %}

{% block content %}
{% include "sde-prep/partials/sde_navbar.html" %}
{% include "sde-prep/partials/user_header.html" %}

<section class="py-10 space-y-6">
  <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
    <div class="space-y-2">
      <p class="text-xs uppercase tracking-[0.2em]" style="color: var(--color-text-tertiary);">SDE Prep</p>
      <h1 class="text-h2">Behavioral Stories</h1>
      <p class="text-body" style="color: var(--color-text-secondary);">
        Capture STAR stories, track readiness, and practice counts.
      </p>
    </div>
    <button id="addStoryBtn" style="background-color: var(--color-accent); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;" type="button">+ Add New Story</button>
  </header>

  <div style="padding: 1.5rem; background-color: var(--color-bg-secondary); border-radius: 0.75rem; border: 1px solid var(--color-border); space-y-4">
    <div class="grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
      <select id="categoryFilter" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit;">
        <option value="all">All Categories</option>
      </select>
      <select id="readinessFilter" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit;">
        <option value="all">All Readiness</option>
        <option value="Not Ready">Not Ready</option>
        <option value="Practicing">Practicing</option>
        <option value="Ready">Ready</option>
      </select>
      <input id="storySearch" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit;" placeholder="Search by title">
      <select id="storySort" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit;">
        <option value="title-asc">Sort: Title</option>
        <option value="category-asc">Sort: Category</option>
        <option value="readiness-asc">Sort: Readiness</option>
        <option value="practice-desc">Sort: Practice Count</option>
      </select>
    </div>
  </div>

  <div id="storyList" class="grid gap-6" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));"></div>
</section>

<div id="storyModal" class="fixed inset-0 hidden items-center justify-center" style="background: rgba(0,0,0,0.4);">
  <div style="padding: 1.5rem; background-color: var(--color-bg-secondary); border-radius: 0.75rem; border: 1px solid var(--color-border); max-w-3xl w-full space-y-4" style="max-height: 90vh; overflow-y: auto;">
    <div class="flex items-start justify-between">
      <div>
        <h2 id="modalStoryTitle" class="text-h3"></h2>
        <p id="modalStoryCategory" class="text-sm" style="color: var(--color-text-secondary);"></p>
      </div>
      <button id="closeStoryModal" class="text-sm" style="color: var(--color-text-secondary);">Close</button>
    </div>

    <div class="grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
      <input id="modalTitleInput" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit;" placeholder="Story title">
      <input id="modalCategoryInput" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit;" placeholder="Category">
      <select id="modalReadiness" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit;">
        <option value="Not Ready">Not Ready</option>
        <option value="Practicing">Practicing</option>
        <option value="Ready">Ready</option>
      </select>
      <div>
        <p class="text-xs uppercase" style="color: var(--color-text-tertiary);">Practice Count</p>
        <div class="flex items-center gap-2">
          <button id="practiceDown" style="background-color: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: var(--color-text-primary); padding: 0.5rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-weight: 600;" type="button">-</button>
          <span id="modalPracticeCount" class="text-body"></span>
          <button id="practiceUp" style="background-color: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: var(--color-text-primary); padding: 0.5rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-weight: 600;" type="button">+</button>
        </div>
      </div>
    </div>

    <div class="grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">
      <textarea id="modalSituation" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit;" rows="3" placeholder="Situation"></textarea>
      <textarea id="modalTask" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit;" rows="3" placeholder="Task"></textarea>
      <textarea id="modalAction" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit;" rows="3" placeholder="Action"></textarea>
      <textarea id="modalResult" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit;" rows="3" placeholder="Result"></textarea>
    </div>

    <textarea id="modalNotes" class="input-walmart w-full" rows="3" placeholder="Notes"></textarea>

    <div class="flex justify-between items-center">
      <button id="deleteStory" style="background-color: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: var(--color-text-primary); padding: 0.5rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-weight: 600;" type="button">Delete</button>
      <button id="saveStory" style="background-color: var(--color-accent); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;" type="button">Save</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const stories = [
    {
      id: 1,
      title: 'Led team through deadline',
      category: 'Leadership',
      readiness: 'Ready',
      practiceCount: 5,
      situation: 'We had a surprise launch with tight timelines.',
      task: 'I needed to align cross-functional teams quickly.',
      action: 'I created a daily standup and simplified scope.',
      result: 'We launched on time with positive feedback.',
      notes: 'Use for Amazon LPs.'
    },
    {
      id: 2,
      title: 'Resolved production incident',
      category: 'Conflict',
      readiness: 'Practicing',
      practiceCount: 2,
      situation: 'A critical bug impacted checkout flow.',
      task: 'Coordinate engineering and support teams.',
      action: 'Prioritized fixes and communicated updates.',
      result: 'Restored service within 2 hours.',
      notes: ''
    },
    {
      id: 3,
      title: 'Learned from failed experiment',
      category: 'Failure',
      readiness: 'Not Ready',
      practiceCount: 0,
      situation: 'Launched an experiment with poor adoption.',
      task: 'Understand the root cause and adjust.',
      action: 'Conducted user interviews and revised plan.',
      result: 'Improved adoption by 35%.',
      notes: ''
    }
  ];

  const categories = ['Leadership', 'Conflict', 'Failure', 'Technical', 'Ownership'];
  const readinessOrder = ['Not Ready', 'Practicing', 'Ready'];

  const categoryFilter = document.getElementById('categoryFilter');
  const readinessFilter = document.getElementById('readinessFilter');
  const storySearch = document.getElementById('storySearch');
  const storySort = document.getElementById('storySort');
  const storyList = document.getElementById('storyList');

  const storyModal = document.getElementById('storyModal');
  const modalStoryTitle = document.getElementById('modalStoryTitle');
  const modalStoryCategory = document.getElementById('modalStoryCategory');
  const modalTitleInput = document.getElementById('modalTitleInput');
  const modalCategoryInput = document.getElementById('modalCategoryInput');
  const modalReadiness = document.getElementById('modalReadiness');
  const modalPracticeCount = document.getElementById('modalPracticeCount');
  const modalSituation = document.getElementById('modalSituation');
  const modalTask = document.getElementById('modalTask');
  const modalAction = document.getElementById('modalAction');
  const modalResult = document.getElementById('modalResult');
  const modalNotes = document.getElementById('modalNotes');

  let activeStory = null;

  function populateFilters() {
    categories.forEach((category) => {
      const option = document.createElement('option');
      option.value = category;
      option.textContent = category;
      categoryFilter.appendChild(option);
    });
  }

  function readinessBadge(value) {
    const colorMap = {
      'Not Ready': 'var(--color-bg-tertiary)',
      Practicing: 'var(--color-warning)',
      Ready: 'var(--color-success)'
    };
    const textColor = value === 'Not Ready' ? 'var(--color-text-primary)' : 'white';
    return `<span style="background-color: ${colorMap[value]}; color: ${textColor}; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">${value}</span>`;
  }

  function getFilteredStories() {
    const category = categoryFilter.value;
    const readiness = readinessFilter.value;
    const query = storySearch.value.toLowerCase();
    let filtered = stories.filter((story) => {
      if (category !== 'all' && story.category !== category) return false;
      if (readiness !== 'all' && story.readiness !== readiness) return false;
      if (query && !story.title.toLowerCase().includes(query)) return false;
      return true;
    });

    const sort = storySort.value;
    filtered = filtered.slice().sort((a, b) => {
      if (sort === 'title-asc') return a.title.localeCompare(b.title);
      if (sort === 'category-asc') return a.category.localeCompare(b.category);
      if (sort === 'readiness-asc') return readinessOrder.indexOf(a.readiness) - readinessOrder.indexOf(b.readiness);
      if (sort === 'practice-desc') return b.practiceCount - a.practiceCount;
      return 0;
    });

    return filtered;
  }

  function renderStories() {
    const filtered = getFilteredStories();
    if (!filtered.length) {
      storyList.innerHTML = '<p class="text-sm" style="color: var(--color-text-tertiary);">No stories found.</p>';
      return;
    }

    storyList.innerHTML = filtered.map((story) => `
      <div style="padding: 1.5rem; background-color: var(--color-bg-secondary); border-radius: 0.75rem; border: 1px solid var(--color-border); space-y-3">
        <div class="flex items-start justify-between">
          <div>
            <h3 class="text-h4">${story.title}</h3>
            <p class="text-sm" style="color: var(--color-text-secondary);">${story.category}</p>
          </div>
          ${readinessBadge(story.readiness)}
        </div>
        <p class="text-xs" style="color: var(--color-text-tertiary);">Practiced ${story.practiceCount} times</p>
        <p class="text-sm" style="color: var(--color-text-secondary);">${story.situation.substring(0, 100)}...</p>
        <button style="background-color: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: var(--color-text-primary); padding: 0.5rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-weight: 600;" data-id="${story.id}">Edit</button>
      </div>
    `).join('');

    storyList.querySelectorAll('button[data-id]').forEach((button) => {
      button.addEventListener('click', () => openModal(Number(button.dataset.id)));
    });
  }

  function openModal(id) {
    const story = stories.find((item) => item.id === id);
    if (!story) return;
    activeStory = story;
    modalStoryTitle.textContent = story.title;
    modalStoryCategory.textContent = story.category;
    modalTitleInput.value = story.title;
    modalCategoryInput.value = story.category;
    modalReadiness.value = story.readiness;
    modalPracticeCount.textContent = story.practiceCount;
    modalSituation.value = story.situation;
    modalTask.value = story.task;
    modalAction.value = story.action;
    modalResult.value = story.result;
    modalNotes.value = story.notes;
    storyModal.classList.remove('hidden');
    storyModal.classList.add('flex');
  }

  function closeModal() {
    storyModal.classList.add('hidden');
    storyModal.classList.remove('flex');
  }

  document.getElementById('practiceUp').addEventListener('click', () => {
    if (!activeStory) return;
    activeStory.practiceCount += 1;
    modalPracticeCount.textContent = activeStory.practiceCount;
  });

  document.getElementById('practiceDown').addEventListener('click', () => {
    if (!activeStory) return;
    activeStory.practiceCount = Math.max(0, activeStory.practiceCount - 1);
    modalPracticeCount.textContent = activeStory.practiceCount;
  });

  document.getElementById('saveStory').addEventListener('click', () => {
    if (!activeStory) return;
    activeStory.title = modalTitleInput.value;
    activeStory.category = modalCategoryInput.value;
    activeStory.readiness = modalReadiness.value;
    activeStory.situation = modalSituation.value;
    activeStory.task = modalTask.value;
    activeStory.action = modalAction.value;
    activeStory.result = modalResult.value;
    activeStory.notes = modalNotes.value;
    renderStories();
    closeModal();
  });

  document.getElementById('deleteStory').addEventListener('click', () => {
    if (!activeStory) return;
    const index = stories.findIndex((item) => item.id === activeStory.id);
    if (index >= 0) {
      stories.splice(index, 1);
      renderStories();
      closeModal();
    }
  });

  document.getElementById('closeStoryModal').addEventListener('click', closeModal);
  storyModal.addEventListener('click', (event) => {
    if (event.target === storyModal) closeModal();
  });

  document.getElementById('addStoryBtn').addEventListener('click', () => {
    const newStory = {
      id: Date.now(),
      title: 'New Story',
      category: 'Leadership',
      readiness: 'Not Ready',
      practiceCount: 0,
      situation: '',
      task: '',
      action: '',
      result: '',
      notes: ''
    };
    stories.unshift(newStory);
    renderStories();
    openModal(newStory.id);
  });

  [categoryFilter, readinessFilter, storySearch, storySort].forEach((input) => {
    input.addEventListener('input', renderStories);
  });

  populateFilters();
  renderStories();
</script>
{% endblock %}
