{% extends "base.html" %}

{% block head %}
  {{ super() }}
{% endblock %}

{% block content %}
{% include "sde-prep/partials/sde_navbar.html" %}
{% include "sde-prep/partials/user_header.html" %}

<section class="py-10 space-y-6">
  <header class="space-y-2">
    <p class="text-xs uppercase tracking-[0.2em]" style="color: var(--color-text-tertiary);">SDE Prep</p>
    <h1 class="text-h2">LeetCode Problems</h1>
    <p class="text-body" style="color: var(--color-text-secondary);">
      Filter, sort, and update your LeetCode progress.
    </p>
  </header>

  <div style="padding: 1.5rem; background-color: var(--color-bg-secondary); border-radius: 0.75rem; border: 1px solid var(--color-border); space-y: 1rem;">
    <div class="grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
      <select id="categoryFilter" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit; cursor: pointer;">
        <option value="all">All Categories</option>
      </select>
      <select id="difficultyFilter" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit; cursor: pointer;">
        <option value="all">All Difficulties</option>
      </select>
      <select id="statusFilter" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit; cursor: pointer;">
        <option value="all">All Statuses</option>
      </select>
      <select id="sortFilter" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit; cursor: pointer;">
        <option value="number-asc">Sort: # Asc</option>
        <option value="number-desc">Sort: # Desc</option>
        <option value="difficulty-asc">Sort: Difficulty</option>
        <option value="category-asc">Sort: Category</option>
        <option value="status-asc">Sort: Status</option>
        <option value="attempts-desc">Sort: Attempts</option>
      </select>
      <label class="flex items-center gap-2 text-sm" style="color: var(--color-text-primary);">
        <input id="blindFilter" type="checkbox" style="width: 1rem; height: 1rem; cursor: pointer;">
        Blind 75 Only
      </label>
    </div>
  </div>

  <div id="problemsTable" style="padding: 1.5rem; background-color: var(--color-bg-secondary); border-radius: 0.75rem; border: 1px solid var(--color-border); overflow-x: auto;"></div>
</section>

<div id="problemModal" class="fixed inset-0 hidden items-center justify-center" style="background: rgba(0,0,0,0.4);">
  <div style="padding: 1.5rem; background-color: var(--color-bg-secondary); border-radius: 0.75rem; border: 1px solid var(--color-border); max-width: 50rem; width: 100%; max-height: 90vh; overflow-y: auto;">
    <div class="flex items-start justify-between" style="margin-bottom: 1.5rem;">
      <div>
        <h2 style="color: var(--color-text-primary); font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;" id="modalTitle"></h2>
        <a id="modalLink" class="text-sm" target="_blank" style="color: var(--color-accent); text-decoration: none;">Open LeetCode</a>
      </div>
      <button id="closeModal" style="background: none; border: none; color: var(--color-text-secondary); cursor: pointer; font-size: 1rem;">Close</button>
    </div>

    <div class="grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); margin-bottom: 1.5rem;">
      <div>
        <p style="color: var(--color-text-tertiary); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.5rem;">Difficulty</p>
        <select id="modalDifficulty" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit; cursor: pointer; width: 100%;"></select>
      </div>
      <div>
        <p style="color: var(--color-text-tertiary); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.5rem;">Category</p>
        <select id="modalCategory" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit; cursor: pointer; width: 100%;"></select>
      </div>
      <div>
        <p style="color: var(--color-text-tertiary); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.5rem;">Status</p>
        <select id="modalStatus" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit; cursor: pointer; width: 100%;"></select>
      </div>
      <div>
        <p style="color: var(--color-text-tertiary); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.5rem;">Attempts</p>
        <div class="flex items-center gap-2">
          <button id="attemptDown" style="background-color: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: var(--color-text-primary); padding: 0.5rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-weight: 600;" type="button">-</button>
          <span id="attemptCount" style="color: var(--color-text-primary); flex: 1; text-align: center;"></span>
          <button id="attemptUp" style="background-color: var(--color-bg-tertiary); border: 1px solid var(--color-border); color: var(--color-text-primary); padding: 0.5rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-weight: 600;" type="button">+</button>
        </div>
      </div>
    </div>

    <div class="grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); margin-bottom: 1.5rem;">
      <input id="timeSpent" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit;" placeholder="Time spent (mins)">
      <input id="complexity" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit;" placeholder="Complexity (Time/Space)">
    </div>

    <textarea id="solutionNotes" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit; width: 100%; margin-bottom: 1rem;" rows="4" placeholder="Solution notes"></textarea>
    <textarea id="personalNotes" style="padding: 0.75rem; background-color: var(--color-bg-primary); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 0.5rem; font-family: inherit; width: 100%; margin-bottom: 1.5rem;" rows="4" placeholder="Personal notes"></textarea>

    <div class="flex justify-between items-center">
      <button id="deleteProblem" style="background-color: #EF4444; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;" type="button">Delete</button>
      <button id="saveProblem" style="background-color: var(--color-accent); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;" type="button">Save</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const problems = [
    {
      id: 1,
      number: 1,
      title: 'Two Sum',
      category: 'Array',
      difficulty: 'Easy',
      status: 'Solved',
      attempts: 3,
      notes: 'Used hash map for O(n).',
      timeSpent: 25,
      complexity: 'O(n) time, O(n) space',
      blind75: true,
      url: 'https://leetcode.com/problems/two-sum/'
    },
    {
      id: 2,
      number: 121,
      title: 'Best Time to Buy and Sell Stock',
      category: 'Array',
      difficulty: 'Easy',
      status: 'In Progress',
      attempts: 1,
      notes: 'Tracking min price.',
      timeSpent: 30,
      complexity: 'O(n) time, O(1) space',
      blind75: true,
      url: 'https://leetcode.com/problems/best-time-to-buy-and-sell-stock/'
    },
    {
      id: 3,
      number: 238,
      title: 'Product of Array Except Self',
      category: 'Array',
      difficulty: 'Medium',
      status: 'Attempted',
      attempts: 2,
      notes: 'Prefix + suffix arrays.',
      timeSpent: 40,
      complexity: 'O(n) time, O(1) space',
      blind75: true,
      url: 'https://leetcode.com/problems/product-of-array-except-self/'
    },
    {
      id: 4,
      number: 200,
      title: 'Number of Islands',
      category: 'Graph',
      difficulty: 'Medium',
      status: 'Solved',
      attempts: 2,
      notes: 'DFS flood fill.',
      timeSpent: 45,
      complexity: 'O(mn) time, O(mn) space',
      blind75: true,
      url: 'https://leetcode.com/problems/number-of-islands/'
    },
    {
      id: 5,
      number: 124,
      title: 'Binary Tree Maximum Path Sum',
      category: 'Tree',
      difficulty: 'Hard',
      status: 'Not Started',
      attempts: 0,
      notes: '',
      timeSpent: 0,
      complexity: '',
      blind75: true,
      url: 'https://leetcode.com/problems/binary-tree-maximum-path-sum/'
    }
  ];

  const categories = ['Array', 'String', 'Tree', 'Graph', 'DP', 'Hash Table'];
  const difficulties = ['Easy', 'Medium', 'Hard'];
  const statuses = ['Not Started', 'Attempted', 'In Progress', 'Solved'];

  const categoryFilter = document.getElementById('categoryFilter');
  const difficultyFilter = document.getElementById('difficultyFilter');
  const statusFilter = document.getElementById('statusFilter');
  const blindFilter = document.getElementById('blindFilter');
  const sortFilter = document.getElementById('sortFilter');
  const table = document.getElementById('problemsTable');

  const modal = document.getElementById('problemModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalLink = document.getElementById('modalLink');
  const modalDifficulty = document.getElementById('modalDifficulty');
  const modalCategory = document.getElementById('modalCategory');
  const modalStatus = document.getElementById('modalStatus');
  const attemptCount = document.getElementById('attemptCount');
  const timeSpent = document.getElementById('timeSpent');
  const complexity = document.getElementById('complexity');
  const solutionNotes = document.getElementById('solutionNotes');
  const personalNotes = document.getElementById('personalNotes');

  let activeProblem = null;

  function populateFilters() {
    categories.forEach((category) => {
      const option = document.createElement('option');
      option.value = category;
      option.textContent = category;
      categoryFilter.appendChild(option);
    });

    difficulties.forEach((difficulty) => {
      const option = document.createElement('option');
      option.value = difficulty;
      option.textContent = difficulty;
      difficultyFilter.appendChild(option);
    });

    statuses.forEach((status) => {
      const option = document.createElement('option');
      option.value = status;
      option.textContent = status;
      statusFilter.appendChild(option);
    });
  }

  function getFilteredProblems() {
    const category = categoryFilter.value;
    const difficulty = difficultyFilter.value;
    const status = statusFilter.value;
    const blindOnly = blindFilter.checked;

    let filtered = problems.filter((problem) => {
      if (category !== 'all' && problem.category !== category) return false;
      if (difficulty !== 'all' && problem.difficulty !== difficulty) return false;
      if (status !== 'all' && problem.status !== status) return false;
      if (blindOnly && !problem.blind75) return false;
      return true;
    });

    const sortValue = sortFilter.value;
    filtered = filtered.slice().sort((a, b) => {
      if (sortValue === 'number-asc') return a.number - b.number;
      if (sortValue === 'number-desc') return b.number - a.number;
      if (sortValue === 'difficulty-asc') return difficulties.indexOf(a.difficulty) - difficulties.indexOf(b.difficulty);
      if (sortValue === 'category-asc') return a.category.localeCompare(b.category);
      if (sortValue === 'status-asc') return statuses.indexOf(a.status) - statuses.indexOf(b.status);
      if (sortValue === 'attempts-desc') return b.attempts - a.attempts;
      return 0;
    });

    return filtered;
  }

  function badge(text, type) {
    const colorMap = {
      Easy: 'var(--color-success)',
      Medium: 'var(--color-warning)',
      Hard: 'var(--color-danger)',
      'Not Started': 'var(--color-bg-tertiary)',
      Attempted: 'var(--color-warning)',
      'In Progress': 'var(--color-warning)',
      Solved: 'var(--color-success)'
    };
    const textColor = ['Not Started'].includes(type) ? 'var(--color-text-primary)' : 'white';
    return `<span style="background-color: ${colorMap[type] || 'var(--color-bg-tertiary)'}; color: ${textColor}; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">${text}</span>`;
  }

  function renderTable() {
    const filtered = getFilteredProblems();
    if (!filtered.length) {
      table.innerHTML = '<p class="text-sm" style="color: var(--color-text-tertiary);">No problems found.</p>';
      return;
    }

    const rows = filtered.map((problem) => `
      <tr class="border-b" style="border-color: var(--color-border);">
        <td class="px-3 py-3 text-sm">${problem.number}</td>
        <td class="px-3 py-3">
          <button class="text-sm font-semibold" style="color: var(--color-accent);" data-id="${problem.id}">${problem.title}</button>
          <p class="text-xs" style="color: var(--color-text-tertiary);">${problem.notes || 'No notes yet'}</p>
        </td>
        <td class="px-3 py-3 text-sm">${problem.category}</td>
        <td class="px-3 py-3">${badge(problem.difficulty, problem.difficulty)}</td>
        <td class="px-3 py-3">${badge(problem.status, problem.status)}</td>
        <td class="px-3 py-3 text-sm">${problem.attempts}</td>
        <td class="px-3 py-3 text-sm">${problem.blind75 ? 'Yes' : 'No'}</td>
        <td class="px-3 py-3"><button class="btn-walmart-secondary" data-id="${problem.id}">Edit</button></td>
      </tr>
    `).join('');

    table.innerHTML = `
      <table class="w-full text-sm">
        <thead>
          <tr style="border-bottom: 1px solid var(--color-border);">
            <th class="text-left px-3 py-2">#</th>
            <th class="text-left px-3 py-2">Problem</th>
            <th class="text-left px-3 py-2">Category</th>
            <th class="text-left px-3 py-2">Difficulty</th>
            <th class="text-left px-3 py-2">Status</th>
            <th class="text-left px-3 py-2">Attempts</th>
            <th class="text-left px-3 py-2">Blind 75</th>
            <th class="text-left px-3 py-2">Action</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;

    table.querySelectorAll('button[data-id]').forEach((button) => {
      button.addEventListener('click', (event) => {
        const id = Number(event.currentTarget.getAttribute('data-id'));
        openModal(id);
      });
    });
  }

  function openModal(id) {
    const problem = problems.find((item) => item.id === id);
    if (!problem) return;
    activeProblem = problem;
    modalTitle.textContent = `#${problem.number} ${problem.title}`;
    modalLink.href = problem.url;
    modalDifficulty.innerHTML = difficulties.map((value) => `<option value="${value}">${value}</option>`).join('');
    modalCategory.innerHTML = categories.map((value) => `<option value="${value}">${value}</option>`).join('');
    modalStatus.innerHTML = statuses.map((value) => `<option value="${value}">${value}</option>`).join('');
    modalDifficulty.value = problem.difficulty;
    modalCategory.value = problem.category;
    modalStatus.value = problem.status;
    attemptCount.textContent = problem.attempts;
    timeSpent.value = problem.timeSpent || '';
    complexity.value = problem.complexity || '';
    solutionNotes.value = problem.notes || '';
    personalNotes.value = problem.notes || '';
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }

  function closeModal() {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }

  function updateProblemFromModal() {
    if (!activeProblem) return;
    activeProblem.difficulty = modalDifficulty.value;
    activeProblem.category = modalCategory.value;
    activeProblem.status = modalStatus.value;
    activeProblem.timeSpent = Number(timeSpent.value) || 0;
    activeProblem.complexity = complexity.value;
    activeProblem.notes = solutionNotes.value;
    activeProblem.notes = personalNotes.value || activeProblem.notes;
    renderTable();
  }

  document.getElementById('attemptUp').addEventListener('click', () => {
    if (!activeProblem) return;
    activeProblem.attempts += 1;
    attemptCount.textContent = activeProblem.attempts;
  });

  document.getElementById('attemptDown').addEventListener('click', () => {
    if (!activeProblem) return;
    activeProblem.attempts = Math.max(0, activeProblem.attempts - 1);
    attemptCount.textContent = activeProblem.attempts;
  });

  document.getElementById('saveProblem').addEventListener('click', () => {
    updateProblemFromModal();
    closeModal();
  });

  document.getElementById('deleteProblem').addEventListener('click', () => {
    if (!activeProblem) return;
    const index = problems.findIndex((item) => item.id === activeProblem.id);
    if (index >= 0) {
      problems.splice(index, 1);
      renderTable();
      closeModal();
    }
  });

  document.getElementById('closeModal').addEventListener('click', closeModal);
  modal.addEventListener('click', (event) => {
    if (event.target === modal) closeModal();
  });

  [categoryFilter, difficultyFilter, statusFilter, blindFilter, sortFilter].forEach((input) => {
    input.addEventListener('change', renderTable);
  });

  populateFilters();
  renderTable();
</script>
{% endblock %}
